<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 å¾·ç‘ç‘å£«ä¹‹æ—…</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --jp-wash: #F8F9F7; --accent: #2C3E50; --highlight: #D4A373; }
        body { background: var(--jp-wash); font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; padding-bottom: 80px; color: #333; }
        .content-section { display: none; padding: 15px; animation: fadeIn 0.3s ease; }
        .content-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card-custom { background: white; border-radius: 12px; padding: 18px; margin-bottom: 12px; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .day-label { font-size: 1.1rem; font-weight: bold; border-bottom: 2.5px solid var(--accent); display: inline-block; margin: 15px 0 10px; letter-spacing: 1px; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #EEE; display: flex; justify-content: space-around; padding: 10px 0; z-index: 1000; }
        .nav-item { color: #BBB; text-decoration: none; text-align: center; font-size: 0.7rem; cursor: pointer; flex: 1; }
        .nav-item.active { color: var(--accent); font-weight: bold; }
        .nav-item i { font-size: 1.3rem; display: block; margin-bottom: 3px; }
        .budget-sum { background: var(--accent); color: white; border-radius: 15px; padding: 25px; text-align: center; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-nav { background: #333; color: white; border-radius: 50px; font-size: 0.75rem; padding: 6px 15px; text-decoration: none; display: inline-flex; align-items: center; }
        .pack-item { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f0f0f0; padding: 8px 0; }
        .pack-text { flex-grow: 1; margin-left: 10px; cursor: pointer; font-size: 0.95rem; }
        .pack-text.checked { text-decoration: line-through; color: #aaa; }
/* æ©«å‘å°è¦½å®¹å™¨ */
        .day-nav-container {
            display: flex;
            overflow-x: auto;
            background: white;
            padding: 15px 10px;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid #f0f0f0;
            -webkit-overflow-scrolling: touch;
        }
        .day-nav-container::-webkit-scrollbar { display: none; }

        /* æ—¥æœŸå¡ç‰‡åŸºç¤æ¨£å¼ */
        .day-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 0 0 auto;
            min-width: 50px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        /* ä¸Šæ’ï¼šæ˜ŸæœŸè‹±æ–‡ */
        .day-tab .day-week {
            font-size: 0.65rem;
            text-transform: uppercase;
            color: #ccc; /* æœªé¸ä¸­ç‚ºæ·ºç°è‰² */
            margin-bottom: 4px;
            letter-spacing: 0.5px;
        }

        /* ä¸‹æ’ï¼šæ—¥æœŸæ•¸å­— */
        .day-tab .day-num {
            font-size: 1.2rem;
            font-weight: 400;
            color: #ddd; /* æœªé¸ä¸­ç‚ºæ·ºç°è‰² */
            position: relative;
            padding-bottom: 8px;
        }

        /* é¸ä¸­ç‹€æ…‹ï¼šæ·±è‰²å¼·èª¿ */
        .day-tab.active .day-week {
            color: #333;
            font-weight: bold;
        }
        .day-tab.active .day-num {
            color: #000;
            font-weight: 700;
        }

        /* é¸ä¸­ç‹€æ…‹ä¸‹æ–¹çš„ç´…é» */
        .day-tab.active .day-num::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background-color: #8B0000; /* æ·±ç´…è‰²å°é» */
            border-radius: 50%;
        }
        /* è¡Œç¨‹å…§å®¹é¡¯ç¤ºæ§åˆ¶ */
        .day-content { display: none; animation: fadeIn 0.4s ease; }
        .day-content.active { display: block; }
        .time-node { border-left: 2px solid #ddd; margin-left: 10px; padding-left: 20px; position: relative; }
        .time-node::before { 
            content: ''; position: absolute; left: -6px; top: 5px; 
            width: 10px; height: 10px; background: var(--accent); border-radius: 50%; 
        }
/* åŒæ­¥ä¸­å¿ƒå¡ç‰‡æ¨£å¼ */
        .sync-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px dashed #D4A373; /* ä½¿ç”¨ä½ å®šç¾©çš„äº®è‰²ä½œç‚ºé‚Šæ¡† */
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }
        .btn-sync {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            width: 100%;
            border: none;
        }
        .btn-export {
            background-color: #2C3E50; /* ä½¿ç”¨ä½ çš„ accent è‰² */
            color: white;
            margin-bottom: 10px;
        }
        .btn-import {
            background-color: white;
            color: #2C3E50;
            border: 1px solid #2C3E50;
        }
        .btn-sync:active {
            transform: scale(0.98);
            opacity: 0.9;
        }
    </style>
</head>
<body>

<div class="p-3 text-center bg-white border-bottom">
    <h1 style="font-size: 1.1rem; letter-spacing: 3px; margin:0; font-weight: 300;">SEPTEMBER 2026 EUROPE</h1>
    <small class="text-muted d-block mb-2" style="font-size: 0.75rem;">Germany â€¢ Norway Cruise â€¢ Switzerland</small>
    
    <div class="d-flex justify-content-center align-items-center gap-4 py-2" style="background: #fdfdfd; border-radius: 8px; font-family: monospace;">
        <div>
            <small class="text-muted d-block" style="font-size: 0.6rem; letter-spacing: 1px;">TAIWAN</small>
            <span id="tw-time" style="font-size: 1.1rem; font-weight: bold; color: #999;">--:--</span>
        </div>
        <div style="height: 25px; width: 1px; background: #eee;"></div>
        <div>
            <small class="text-primary d-block" style="font-size: 0.6rem; letter-spacing: 1px;">EUROPE (-6h)</small>
            <span id="eu-time" style="font-size: 1.1rem; font-weight: bold; color: #2C3E50;">--:--</span>
        </div>
    </div>
</div>
<div id="itinerary" class="content-section active">
    <div class="day-nav-container">
        <div class="day-tab active" onclick="switchDay('all', this)">
            <span class="day-week">ALL</span><span class="day-num">ç¸½è¦½</span>
        </div>
        <div class="day-tab" onclick="switchDay('910', this)"><span class="day-week">THU</span><span class="day-num">10</span></div>
        <div class="day-tab" onclick="switchDay('911', this)"><span class="day-week">FRI</span><span class="day-num">11</span></div>
        <div class="day-tab" onclick="switchDay('912', this)"><span class="day-week">SAT</span><span class="day-num">12</span></div>
        <div class="day-tab" onclick="switchDay('913', this)"><span class="day-week">SUN</span><span class="day-num">13</span></div>
        <div class="day-tab" onclick="switchDay('914', this)"><span class="day-week">MON</span><span class="day-num">14</span></div>
        <div class="day-tab" onclick="switchDay('915', this)"><span class="day-week">TUE</span><span class="day-num">15</span></div>
        <div class="day-tab" onclick="switchDay('916', this)"><span class="day-week">WED</span><span class="day-num">16</span></div>
        <div class="day-tab" onclick="switchDay('917', this)"><span class="day-week">THU</span><span class="day-num">17</span></div>
        <div class="day-tab" onclick="switchDay('918', this)"><span class="day-week">FRI</span><span class="day-num">18</span></div>
        <div class="day-tab" onclick="switchDay('919', this)"><span class="day-week">SAT</span><span class="day-num">19</span></div>
        <div class="day-tab" onclick="switchDay('920', this)"><span class="day-week">SUN</span><span class="day-num">20</span></div>
        <div class="day-tab" onclick="switchDay('921', this)"><span class="day-week">MON</span><span class="day-num">21</span></div>
        <div class="day-tab" onclick="switchDay('922', this)"><span class="day-week">TUE</span><span class="day-num">22</span></div>
        <div class="day-tab" onclick="switchDay('923', this)"><span class="day-week">WED</span><span class="day-num">23</span></div>
        <div class="day-tab" onclick="switchDay('924', this)"><span class="day-week">THU</span><span class="day-num">24</span></div>
        <div class="day-tab" onclick="switchDay('925', this)"><span class="day-week">FRI</span><span class="day-num">25</span></div>
        <div class="day-tab" onclick="switchDay('926', this)"><span class="day-week">SAT</span><span class="day-num">26</span></div>
        <div class="day-tab" onclick="switchDay('927', this)"><span class="day-week">SUN</span><span class="day-num">27</span></div>
        <div class="day-tab" onclick="switchDay('928', this)"><span class="day-week">MON</span><span class="day-num">28</span></div>
    </div>

    <div id="day-all" class="day-content active">
        <div class="card-custom">
            <h5 class="fw-bold">2026 å¾·ç‘æŒªå£¯éŠ ğŸ‡ªğŸ‡º</h5>
            <p class="small text-muted">é«˜é›„å‡ºç™¼ï¼Œæ©«è·¨å¾·åœ‹ã€æŒªå¨éƒµè¼ªèˆ‡ç‘å£«æ·±åº¦éŠã€‚</p>
            <div class="badge bg-dark">Total 19 Days</div>
        </div>
    </div>

    <div id="day-910" class="day-content"><div class="card-custom"><h6 class="fw-bold text-primary mb-3">âœˆï¸ å•Ÿç¨‹é£›è¡Œ</h6><div class="time-node"><b>19:10 é«˜é›„ (KHH)</b><br><small>æ­ä¹˜å‰å¾€é¦™æ¸¯ (1h 40m)</small></div><div class="time-node mt-3"><b>23:55 é¦™æ¸¯ (HKG)</b><br><small>å‰å¾€æ³•è˜­å…‹ç¦ (13h 20m)</small></div></div></div>
    <div id="day-911" class="day-content"><div class="card-custom"><h6 class="fw-bold text-primary mb-3">ğŸ‡©ğŸ‡ª æŠµé”å¾·åœ‹</h6><div class="time-node"><b>07:15 æŠµé” FRA T2</b></div><div class="time-node mt-3"><b>09:41 ICE é«˜éµ</b><br><small>æ³•è˜­å…‹ç¦ â” 15:21 æŠµé”åŸºçˆ¾ (Kiel)</small></div></div></div>
    <div id="day-912" class="day-content"><div class="card-custom"><h6 class="fw-bold text-primary mb-3">ğŸš¢ ç™»èˆ¹ï¼šåŸºçˆ¾ Kiel</h6><p class="small">ä¸‹åˆ 19:00 å•Ÿèˆªï¼Œé–‹å•ŸæŒªå¨å³½ç£ä¹‹æ—…ã€‚</p></div></div>
    
    <div id="day-913" class="day-content"><div class="card-custom"><h6>ğŸš¢ éƒµè¼ªèˆªè¡Œä¸­ - å“¥æœ¬å“ˆæ ¹</h6></div></div>
    <div id="day-914" class="day-content"><div class="card-custom"><h6>ğŸš¢ éƒµè¼ªèˆªè¡Œä¸­ - æµ·ä¸Šå·¡èˆª</h6></div></div>
    <div id="day-915" class="day-content"><div class="card-custom"><h6>ğŸš¢ éƒµè¼ªèˆªè¡Œä¸­ - å¸Œé›·æ–¯åˆ©ç‰¹</h6></div></div>
    <div id="day-916" class="day-content"><div class="card-custom"><h6>ğŸš¢ éƒµè¼ªèˆªè¡Œä¸­ - å¥§å‹’æ¾</h6></div></div>
    <div id="day-917" class="day-content"><div class="card-custom"><h6>ğŸš¢ éƒµè¼ªèˆªè¡Œä¸­ - å¼—æ´›å§†</h6></div></div>
    <div id="day-918" class="day-content"><div class="card-custom"><h6>ğŸš¢ éƒµè¼ªèˆªè¡Œä¸­ - æµ·ä¸Šå·¡èˆª</h6></div></div>

    <div id="day-919" class="day-content"><div class="card-custom"><h6 class="fw-bold text-primary mb-3">âœˆï¸ æ¼¢å ¡ â” è˜‡é»ä¸– â” ç‰æ£®</h6><p class="small">æŠµé”ç‘å£«ï¼Œå‚æ™šé€›è€åŸå€èˆ‡å¡è²çˆ¾æ©‹ã€‚</p></div></div>
    <div id="day-920" class="day-content"><div class="card-custom"><h6 class="fw-bold text-primary mb-3">ğŸš  éµåŠ›å£«å±± (Titlis)</h6><p class="small">ä¸‹åˆç§»å‹•è‡³æº«æ ¹ (Wengen) å…¥ä½ã€‚</p></div></div>
    <div id="day-921" class="day-content"><div class="card-custom"><h6 class="fw-bold text-primary mb-3">ğŸ”ï¸ å¥è¡Œï¼šMÃ¤nnlichen â” å°å¤æˆ´å…‹</h6><p class="small">å…¨æ™¯å¥è¡Œ (2h) â” æ ¼æ—å¾·ç“¦ â” First å±±ã€‚</p></div></div>
    <div id="day-922" class="day-content"><div class="card-custom"><h6 class="fw-bold text-primary mb-3">ğŸ”ï¸ é›ªæœ—å³° (Schilthorn)</h6><p class="small">æˆ–å‰å¾€å„è¥¿å«©æ¹– (Oeschinensee)ã€‚å®¿æº«æ ¹ã€‚</p></div></div>
    <div id="day-923" class="day-content"><div class="card-custom"><h6 class="fw-bold text-primary mb-3">ğŸ—» å‰å¾€ç­–é¦¬ç‰¹ (Zermatt)</h6><p class="small">å…¥ä½ç­–é¦¬ç‰¹ï¼Œå‚æ™šé€›é®ä¸Šå•†åº—ã€‚</p></div></div>
    <div id="day-924" class="day-content"><div class="card-custom"><h6 class="fw-bold text-primary mb-3">ğŸ—» å†°å·å¤©å ‚ (Glacier Paradise)</h6><p class="small">ç­–é¦¬ç‰¹å‘¨é‚Šæ™¯é»æ¢ç´¢ã€‚</p></div></div>
    <div id="day-925" class="day-content"><div class="card-custom"><h6 class="fw-bold text-primary mb-3">ğŸ—» ç­–é¦¬ç‰¹å‘¨é‚Š</h6><p class="small">Sunnegga äº”æ¹–å¥è¡Œæˆ–é®ä¸Šæ”¾é¬†ã€‚</p></div></div>
    <div id="day-926" class="day-content"><div class="card-custom"><h6 class="fw-bold text-primary mb-3">ğŸ‡®ğŸ‡¹ å‰å¾€ç±³è˜­ (Milan)</h6><p class="small">ç¶“ Visp è½‰è»Šï¼Œå…¥ä½ç±³è˜­ã€‚</p></div></div>
    <div id="day-927" class="day-content"><div class="card-custom border-start border-4 border-danger"><h6 class="fw-bold text-danger mb-3">âœˆï¸ è³¦æ­¸ (MXP - HKG)</h6><div class="time-node"><b>12:45 ç±³è˜­ (MXP) èµ·é£›</b><br><small>å‰å¾€é¦™æ¸¯ (11h 40m)</small></div></div></div>
    <div id="day-928" class="day-content"><div class="card-custom"><h6 class="fw-bold text-success mb-3">ğŸ  æŠµé”é«˜é›„</h6><div class="time-node"><b>06:25 æŠµé”é¦™æ¸¯ (HKG)</b></div><div class="time-node mt-3"><b>08:35 é¦™æ¸¯ â” 10:15 é«˜é›„</b></div></div></div>
</div> 
</div>
</div>

<div id="budget" class="content-section">
    <div class="budget-sum">
        <small style="opacity: 0.8; letter-spacing: 1px;">æ—…ç¨‹ç¸½æ”¯å‡ºä¼°ç®— (TWD)</small>
        <div class="h1 my-2">NT$ <span id="total-twd">0</span></div>
        <div class="small" style="font-size:0.75rem; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px;">
            CHF: <span id="total-chf">0</span> | EUR: <span id="total-eur">0</span> | HKD: <span id="total-hkd">0</span>
        </div>
    </div>

    <div class="card-custom">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="fw-bold m-0">åŒ¯ç‡è¨­å®š</h6>
            <button class="btn btn-sm btn-outline-primary" style="font-size: 0.7rem;" onclick="fetchRates()">
                <i class="fas fa-sync-alt"></i> æ›´æ–°å³æ™‚åŒ¯ç‡
            </button>
        </div>
        <div class="row g-2 mb-3">
            <div class="col-4"><label class="small text-muted">CHFâ”TWD</label><input type="number" id="rate-chf" class="form-control form-control-sm" value="38.5" onchange="render()"></div>
            <div class="col-4"><label class="small text-muted">EURâ”TWD</label><input type="number" id="rate-eur" class="form-control form-control-sm" value="34.2" onchange="render()"></div>
            <div class="col-4"><label class="small text-muted">HKDâ”TWD</label><input type="number" id="rate-hkd" class="form-control form-control-sm" value="4.1" onchange="render()"></div>
        </div>
        <hr>
        <input type="text" id="exp-name" class="form-control form-control-sm mb-2" placeholder="é …ç›® (å¦‚: æ©Ÿå ´æ™šé¤)">
        <div class="input-group input-group-sm mb-2">
            <select id="exp-curr" class="form-select" style="max-width: 85px;"><option>CHF</option><option>EUR</option><option>HKD</option><option>TWD</option></select>
            <input type="number" id="exp-amt" class="form-control" placeholder="é‡‘é¡">
        </div>
        <textarea id="exp-note" class="form-control form-control-sm mb-2" placeholder="å‚™è¨»å…§å®¹"></textarea>
        <button class="btn btn-dark w-100 btn-sm shadow-sm" onclick="addExp()">è¨˜éŒ„é€™ç­†æ”¯å‡º</button>
    </div>
    <div id="exp-list"></div>
    <button class="btn btn-link btn-sm w-100 text-muted mt-4" onclick="clearAll()">æ¸…ç©ºæ‰€æœ‰è¨˜å¸³ç´€éŒ„</button>
</div>
<div id="packing" class="content-section">
    <div class="day-label">ğŸ§³ è¡Œææ¸…å–®</div>
    
    <div class="card-custom mb-3">
        <div class="input-group input-group-sm">
            <input type="text" id="new-cat-input" class="form-control" placeholder="æ–°å¢é¡åˆ¥ (å¦‚ï¼šåŒ–å¦å“)">
            <button class="btn btn-dark" onclick="addNewCategory()">å»ºç«‹åˆ†é¡</button>
        </div>
    </div>

    <div id="pack-list-container"></div>
    
    <button class="btn btn-link btn-sm w-100 text-muted mt-2" onclick="clearCheckedItems()">æ¸…é™¤æ‰€æœ‰å·²å‹¾é¸é …ç›®</button>
</div>
</div>

<div id="info" class="content-section">
    <div class="day-label">ğŸ”— å¿«é€Ÿé€£çµèˆ‡é›»è©±</div>
    <div class="card-custom">
        <h6 class="fw-bold">ç·Šæ€¥é€£çµ¡</h6>
        <p class="small mb-2">å¤–äº¤éƒ¨æ€¥é›£æ•‘åŠ©ï¼š+886-800-085-095</p>
        <hr>
        <h6 class="fw-bold">å¸¸ç”¨é€£çµ</h6>
        <div class="d-grid gap-2">
            <a href="https://www.sbb.ch/en" target="_blank" class="btn btn-sm btn-outline-dark text-start">SBB ç‘å£«åœ‹éµå®˜ç¶²</a>
            <a href="https://www.meteoswiss.admin.ch/" target="_blank" class="btn btn-sm btn-outline-dark text-start">MeteoSwiss ç‘å£«å¤©æ°£</a>
        </div>
    </div>

    <div class="sync-card">
        <div class="text-center mb-3">
            <h6 class="fw-bold mb-1">ğŸ‘« éšŠå‹åŒæ­¥ä¸­å¿ƒ</h6>
            <small class="text-muted">åŒæ­¥è¨˜å¸³ç´€éŒ„èˆ‡è¡Œææ¸…å–®</small>
        </div>
        <button class="btn-sync btn-export" onclick="exportData()">
            <i class="fas fa-share-square"></i> åŒ¯å‡ºä¸¦è¤‡è£½æ•¸æ“šä»£ç¢¼
        </button>
        <button class="btn-sync btn-import" onclick="importData()">
            <i class="fas fa-file-import"></i> è²¼ä¸Šæœ‹å‹çš„ä»£ç¢¼åŒæ­¥
        </button>
        <div class="text-center mt-2">
            <small style="font-size: 0.65rem; color: #999;">æ³¨æ„ï¼šåŒæ­¥æœƒè¦†è“‹æ‰ç›®å‰çš„æœ¬åœ°æ•¸æ“š</small>
        </div>
    </div>
</div>
<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('itinerary', this)"><i class="fas fa-calendar-alt"></i>è¡Œç¨‹</div>
    <div class="nav-item" onclick="switchTab('info', this)"><i class="fas fa-info-circle"></i>è³‡è¨Š</div>
    <div class="nav-item" onclick="switchTab('budget', this)"><i class="fas fa-wallet"></i>è¨˜å¸³</div>
    <div class="nav-item" onclick="switchTab('packing', this)"><i class="fas fa-check-square"></i>è¡Œæ</div>
    </nav>

<script>
// --- ä¸–ç•Œæ™‚é˜é‚è¼¯ ---
function updateClocks() {
    const now = new Date();
    // å°ç£æ™‚é–“ (UTC+8)
    const twTime = new Intl.DateTimeFormat('zh-TW', {
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: 'Asia/Taipei'
    }).format(now);
    
    // æ­æ´²æ™‚é–“ (ä¸­æ­å¤ä»¤æ™‚é–“ UTC+2)
    const euTime = new Intl.DateTimeFormat('zh-TW', {
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: 'Europe/Berlin'
    }).format(now);

    const twEl = document.getElementById('tw-time');
    const euEl = document.getElementById('eu-time');
    if(twEl) twEl.innerText = twTime;
    if(euEl) euEl.innerText = euTime;
}
// æ¯ç§’æ›´æ–°ä¸€æ¬¡
setInterval(updateClocks, 1000);
// --- åŸºç¤åˆ†é åˆ‡æ› ---
function switchTab(id, el) {
    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    el.classList.add('active');
    window.scrollTo(0,0);
}

function switchDay(dayId, el) {
    const container = el.parentElement;
    container.querySelectorAll('.day-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    document.querySelectorAll('.day-content').forEach(c => c.classList.remove('active'));
    const target = document.getElementById('day-' + dayId);
    if (target) target.classList.add('active');
    window.scrollTo(0, 0);
}

// --- è¨˜å¸³é‚è¼¯ ---
let expenses = JSON.parse(localStorage.getItem('trip_v2026')) || [];

function addExp() {
    const name = document.getElementById('exp-name').value;
    const amt = document.getElementById('exp-amt').value;
    const curr = document.getElementById('exp-curr').value;
    const note = document.getElementById('exp-note').value;
    
    if (name && amt) {
        expenses.push({ name, amt: parseFloat(amt), curr, note, id: Date.now() });
        document.getElementById('exp-name').value = ''; 
        document.getElementById('exp-amt').value = ''; 
        document.getElementById('exp-note').value = '';
        render(); // é‡æ–°æ¸²æŸ“
    } else {
        alert("è«‹è¼¸å…¥é …ç›®åç¨±èˆ‡é‡‘é¡");
    }
}

function deleteExp(id) {
    expenses = expenses.filter(e => e.id !== id);
    render();
}

function clearAll() {
    if(confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è¨˜å¸³ç´€éŒ„å—ï¼Ÿ")) {
        expenses = [];
        render();
    }
}

// æ ¸å¿ƒä¿®æ­£ï¼šè£œå› render å‡½æ•¸
function render() {
    localStorage.setItem('trip_v2026', JSON.stringify(expenses));
    
    const rCHF = parseFloat(document.getElementById('rate-chf').value) || 0;
    const rEUR = parseFloat(document.getElementById('rate-eur').value) || 0;
    const rHKD = parseFloat(document.getElementById('rate-hkd').value) || 0;
    
    let tTWD = 0, tCHF = 0, tEUR = 0, tHKD = 0;
    let html = '';

    expenses.forEach(e => {
        let twd = 0;
        if (e.curr === 'CHF') { twd = e.amt * rCHF; tCHF += e.amt; }
        else if (e.curr === 'EUR') { twd = e.amt * rEUR; tEUR += e.amt; }
        else if (e.curr === 'HKD') { twd = e.amt * rHKD; tHKD += e.amt; }
        else { twd = e.amt; }
        tTWD += twd;

        html += `
            <div class="card-custom mb-2">
                <div class="d-flex justify-content-between">
                    <div>
                        <span class="fw-bold">${e.name}</span>
                        <div class="small text-muted">${e.amt} ${e.curr} <i class="fas fa-arrow-right mx-1"></i> NT$ ${Math.round(twd)}</div>
                        ${e.note ? `<div class="small text-secondary mt-1">${e.note}</div>` : ''}
                    </div>
                    <button class="btn btn-sm text-danger" onclick="deleteExp(${e.id})"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>`;
    });

    document.getElementById('exp-list').innerHTML = html;
    document.getElementById('total-twd').innerText = Math.round(tTWD).toLocaleString();
    document.getElementById('total-chf').innerText = tCHF.toFixed(1);
    document.getElementById('total-eur').innerText = tEUR.toFixed(1);
    document.getElementById('total-hkd').innerText = tHKD.toFixed(1);
}

// --- åŒ¯ç‡ç²å– ---
async function fetchRates() {
    try {
        const res = await fetch('https://open.er-api.com/v6/latest/TWD');
        const data = await res.json();
        if (data && data.rates) {
            document.getElementById('rate-chf').value = (1 / data.rates.CHF).toFixed(2);
            document.getElementById('rate-eur').value = (1 / data.rates.EUR).toFixed(2);
            document.getElementById('rate-hkd').value = (1 / data.rates.HKD).toFixed(2);
            alert('åŒ¯ç‡å·²æ›´æ–°ï¼');
            render();
        }
    } catch (e) {
        alert('ç„¡æ³•ç²å–å³æ™‚åŒ¯ç‡');
    }
}

// --- è¡Œææ¸…å–®é‚è¼¯ ---
let categorizedPack = JSON.parse(localStorage.getItem('trip_pack_cat')) || [];

function addNewCategory() {
    const catInput = document.getElementById('new-cat-input');
    const catName = catInput.value.trim();
    if (!catName) return;
    if (categorizedPack.find(c => c.category === catName)) { alert("æ­¤é¡åˆ¥å·²å­˜åœ¨"); return; }
    categorizedPack.push({ category: catName, items: [] });
    catInput.value = "";
    renderPackList();
}

function addItemToCat(catIdx) {
    const itemName = prompt(`åœ¨ã€Œ${categorizedPack[catIdx].category}ã€æ–°å¢é …ç›®ï¼š`);
    if (itemName && itemName.trim() !== "") {
        categorizedPack[catIdx].items.push({ text: itemName.trim(), checked: false });
        renderPackList();
    }
}

function toggleItem(catIdx, itemIdx) {
    categorizedPack[catIdx].items[itemIdx].checked = !categorizedPack[catIdx].items[itemIdx].checked;
    renderPackList();
}

function deleteCategory(catIdx) {
    if(confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${categorizedPack[catIdx].category}ã€æ•´å€‹åˆ†é¡å—ï¼Ÿ`)) {
        categorizedPack.splice(catIdx, 1);
        renderPackList();
    }
}

function deleteSingleItem(catIdx, itemIdx) {
    categorizedPack[catIdx].items.splice(itemIdx, 1);
    renderPackList();
}

function renderPackList() {
    const container = document.getElementById('pack-list-container');
    if (!container) return;
    container.innerHTML = '';
    categorizedPack.forEach((catObj, catIdx) => {
        let catHtml = `<div class="card-custom mb-3">
            <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                <span class="fw-bold text-primary"># ${catObj.category}</span>
                <div>
                    <button class="btn btn-sm btn-outline-dark py-0" onclick="addItemToCat(${catIdx})">+ é …ç›®</button>
                    <button class="btn btn-sm text-danger ms-2" onclick="deleteCategory(${catIdx})"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>`;
        if (catObj.items.length === 0) {
            catHtml += `<div class="text-center py-2 small text-muted">æš«ç„¡é …ç›®</div>`;
        }
        catObj.items.forEach((item, itemIdx) => {
            catHtml += `<div class="pack-item d-flex align-items-center justify-content-between py-1">
                <div class="d-flex align-items-center flex-grow-1" onclick="toggleItem(${catIdx}, ${itemIdx})">
                    <input type="checkbox" ${item.checked ? 'checked' : ''}>
                    <span class="pack-text ${item.checked ? 'checked' : ''} ms-2">${item.text}</span>
                </div>
                <button class="btn btn-sm text-muted" onclick="deleteSingleItem(${catIdx}, ${itemIdx})">Ã—</button>
            </div>`;
        });
        catHtml += `</div>`;
        container.innerHTML += catHtml;
    });
    localStorage.setItem('trip_pack_cat', JSON.stringify(categorizedPack));
}

function clearCheckedItems() {
    if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å·²å‹¾é¸é …ç›®å—ï¼Ÿ")) {
        categorizedPack.forEach(cat => cat.items = cat.items.filter(item => !item.checked));
        renderPackList();
    }
}

// 1. çµ±ä¸€çš„åˆå§‹åŒ–å‡½æ•¸
function initializePage() {
    console.log("é é¢åˆå§‹åŒ–ä¸­...");
    // é‡æ–°æŠ“å–è³‡æ–™
    expenses = JSON.parse(localStorage.getItem('trip_v2026')) || [];
    categorizedPack = JSON.parse(localStorage.getItem('trip_pack_cat')) || [];

    // åŸ·è¡Œæ¸²æŸ“
    if (typeof render === "function") render();
    if (typeof renderPackList === "function") renderPackList();
}

// 2. ä¿®æ­£å¾Œçš„åŒ¯å…¥å‡½æ•¸
function importData() {
    const code = prompt("è«‹è²¼ä¸Šæœ‹å‹å‚³çµ¦ä½ çš„åŒæ­¥ä»£ç¢¼ï¼š");
    if (!code) return;

    try {
        const decoded = JSON.parse(decodeURIComponent(atob(code)));
        
        // å¯«å…¥å„²å­˜ç©ºé–“
        if (decoded.expenses) localStorage.setItem('trip_v2026', decoded.expenses);
        if (decoded.packing) localStorage.setItem('trip_pack_cat', decoded.packing);
        
        alert('ğŸš€ åŒæ­¥æˆåŠŸï¼å³å°‡æ›´æ–°ç•«é¢ã€‚');
        
        // é—œéµï¼šå…ˆåˆ·æ–°æ•¸æ“šå†é‡æ–°æ•´ç†
        initializePage();
        location.reload(); 
    } catch (e) {
        console.error(e);
        alert('âŒ ä»£ç¢¼ç„¡æ•ˆï¼Œè«‹ç¢ºä¿è¤‡è£½å®Œæ•´ã€‚');
    }
}

// 3. ç¢ºä¿åŒ¯å‡ºæŒ‰éˆ•æ­£å¸¸çš„å‡½æ•¸ (è£œå¼·ç‰ˆ)
function exportData() {
    try {
        const data = {
            expenses: localStorage.getItem('trip_v2026'),
            packing: localStorage.getItem('trip_pack_cat')
        };
        
        if (!data.expenses && !data.packing) {
            alert('ç›®å‰é‚„æ²’æœ‰æ•¸æ“šå¯ä»¥åŒ¯å‡ºå–”ï¼');
            return;
        }

        const code = btoa(encodeURIComponent(JSON.stringify(data)));
        
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(code).then(() => {
                alert('âœ… æˆåŠŸï¼åŒæ­¥ä»£ç¢¼å·²è¤‡è£½ã€‚\nè«‹å‚³é€çµ¦æœ‹å‹è²¼ä¸Šã€‚');
            }).catch(err => fallbackCopy(code));
        } else {
            fallbackCopy(code);
        }
    } catch (err) {
        alert("åŒ¯å‡ºå¤±æ•—ï¼š" + err);
    }
}

// 4. åªæœ‰ä¸€å€‹ onloadï¼Œç¢ºä¿æ‰€æœ‰äº‹æƒ…éƒ½åœ¨é€™è£¡ç™¼ç”Ÿ
window.onload = function() {
    initializePage();
    updateClocks(); // ç¢ºä¿é é¢ä¸€æ‰“é–‹å°±é¡¯ç¤ºæ™‚é–“
};
</script>
</body>
</html>
